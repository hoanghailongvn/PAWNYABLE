#!/bin/sh

musl-gcc heap_exploit_core_pattern.c -o exploit -static

if [ $? -ne 0 ]; then
    echo "compile failed, exiting."
    exit 1
fi

musl-gcc heap_exploit_core_pattern_crasher.c -o exploit_crasher -static

mv exploit root
mv exploit_crasher root
cd root; find . -print0 | cpio -o --null --owner=root --format=newc > ../debugfs.cpio
cd ../

qemu-system-x86_64 \
    -m 64M \
    -nographic \
    -kernel bzImage \
    -append "console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on nokaslr" \
    -no-reboot \
    -cpu qemu64,+smap,+smep \
    -smp 1 \
    -monitor /dev/null \
    -initrd debugfs.cpio \
    -net nic,model=virtio \
    -s \
    -net user
